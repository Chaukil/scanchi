<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quét Văn Bản - OCR Scanner (Nâng Cấp)</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        #video {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        #canvas { display: none; }
        .preview-img { max-width: 100%; border-radius: 10px; margin-top: 20px; }
        .btn-custom { border-radius: 25px; padding: 10px 30px; font-weight: 600; transition: all 0.3s; }
        .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .progress-container { display: none; margin-top: 20px; }
        .table-container { max-height: 400px; overflow-y: auto; }
        .scan-count { background: #667eea; color: white; padding: 10px 20px; border-radius: 25px; font-weight: 600; display: inline-block; margin-bottom: 15px; }
        .alert-custom { border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <h1 class="text-center mb-4"><i class="fas fa-camera"></i> Quét và Nhận Diện Văn Bản</h1>
            
            <div class="row">
                <div class="col-md-7">
                    <h4>Camera</h4>
                    <video id="video" autoplay></video>
                    <canvas id="canvas"></canvas>
                    
                    <div class="mt-3 text-center">
                        <button id="startCamera" class="btn btn-primary btn-custom"><i class="fas fa-video"></i> Bật Camera</button>
                        <button id="captureBtn" class="btn btn-success btn-custom" disabled><i class="fas fa-camera"></i> Chụp Ảnh</button>
                        <button id="stopCamera" class="btn btn-danger btn-custom" disabled><i class="fas fa-stop"></i> Tắt Camera</button>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Hoặc tải ảnh lên:</label>
                        <input type="file" id="fileInput" class="form-control" accept="image/*">
                    </div>
                </div>
                
                <div class="col-md-5">
                    <h4>Xem trước ảnh</h4>
                    <div id="previewContainer" class="text-center">
                        <i class="fas fa-image fa-3x text-muted"></i>
                        <p class="text-muted">Ảnh đã chụp hoặc tải lên sẽ hiện ở đây.</p>
                    </div>

                    <div class="progress-container">
                        <div class="alert alert-info alert-custom"><i class="fas fa-spinner fa-spin"></i> Đang xử lý ảnh...</div>
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Table -->
        <div class="main-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4>Danh Sách Đã Quét</h4>
                    <span class="scan-count"><i class="fas fa-list"></i> Tổng số mục: <span id="totalCount">0</span></span>
                </div>
                <div>
                    <button id="clearAll" class="btn btn-warning btn-custom"><i class="fas fa-trash"></i> Xóa Tất Cả</button>
                    <button id="exportBtn" class="btn btn-success btn-custom"><i class="fas fa-file-excel"></i> Xuất Excel</button>
                </div>
            </div>
            <div class="table-container">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr><th>STT</th><th>Item</th><th>Số Lượng</th><th>Thao Tác</th></tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr><td colspan="4" class="text-center text-muted">Chưa có dữ liệu.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel"><i class="fas fa-check-double"></i> Xác nhận kết quả quét</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="alert alert-info">Kiểm tra và chỉnh sửa lại các mục dưới đây trước khi thêm vào danh sách chính.</p>
                    <table class="table table-bordered">
                        <thead>
                            <tr><th>Item</th><th>Số Lượng</th><th>Xóa</th></tr>
                        </thead>
                        <tbody id="confirmationTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" id="addAllBtn" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Thêm Tất Cả vào Danh Sách</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        // Global variables
        let stream = null;
        let scannedData = [];
        let confirmationModal = null;
        
        // Element selectors
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('startCamera');
        const stopCameraBtn = document.getElementById('stopCamera');
        const captureBtn = document.getElementById('captureBtn');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.getElementById('progressBar');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const totalCount = document.getElementById('totalCount');
        const clearAllBtn = document.getElementById('clearAll');
        const exportBtn = document.getElementById('exportBtn');
        const confirmationTableBody = document.getElementById('confirmationTableBody');
        const addAllBtn = document.getElementById('addAllBtn');

        document.addEventListener('DOMContentLoaded', () => {
            confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        });
        
        // Start Camera
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                captureBtn.disabled = false;
            } catch (error) { alert('Không thể truy cập camera: ' + error.message); }
        });
        
        // Stop Camera
        stopCameraBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
                captureBtn.disabled = true;
            }
        });
        
        // Capture Photo
        captureBtn.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob(blob => processImage(blob));
        });
        
        // File Upload
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) processImage(e.target.files[0]);
        });
        
        // Process Image with OCR
        async function processImage(imageData) {
            previewContainer.innerHTML = `<img src="${URL.createObjectURL(imageData)}" class="preview-img" alt="Preview">`;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                const result = await Tesseract.recognize(
                    imageData, 'vie+eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                progressBar.style.width = Math.round(m.progress * 100) + '%';
                            }
                        }
                    }
                );
                progressContainer.style.display = 'none';
                extractAndConfirm(result.data.text);
            } catch (error) {
                alert('Lỗi khi xử lý ảnh: ' + error.message);
                progressContainer.style.display = 'none';
            }
        }
        
        // *** NEW FUNCTION: Extract all items from text and show confirmation modal ***
        function extractAndConfirm(text) {
            const lines = text.split('\n');
            const foundItems = [];
            // Regex to find a line with STT, an Item Code, and an optional Quantity at the end
            // Example line: "8 WNK79008 40"
            const lineRegex = /^\s*\d+\s+([A-Z0-9]+)(?:\s+(\d+))?.*/;

            for (const line of lines) {
                const match = line.trim().match(lineRegex);
                if (match) {
                    // match[1] is the Item code (e.g., "WNK79008")
                    // match[2] is the Quantity (e.g., "40"), which might be undefined
                    const item = match[1];
                    const quantity = match[2] ? parseInt(match[2], 10) : 1; // Default to 1 if no quantity is found
                    
                    if (item) {
                       foundItems.push({ item, quantity });
                    }
                }
            }

            if (foundItems.length === 0) {
                alert('Không tìm thấy item nào hợp lệ. Vui lòng thử lại với ảnh rõ hơn.');
                return;
            }

            // Populate confirmation table
            confirmationTableBody.innerHTML = foundItems.map((item, index) => `
                <tr data-index="${index}">
                    <td><input type="text" class="form-control" value="${item.item}"></td>
                    <td><input type="number" class="form-control" value="${item.quantity}" min="1"></td>
                    <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
            
            // Show confirmation modal
            confirmationModal.show();
        }

        // *** NEW FUNCTION: Add all confirmed items to the main list ***
        addAllBtn.addEventListener('click', () => {
            const rows = confirmationTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const itemInput = row.querySelector('input[type="text"]');
                const quantityInput = row.querySelector('input[type="number"]');
                const item = itemInput.value.trim();
                const quantity = parseInt(quantityInput.value, 10);

                if (item && quantity > 0) {
                    addOrUpdateItem(item, quantity);
                }
            });

            confirmationModal.hide();
            previewContainer.innerHTML = '<i class="fas fa-image fa-3x text-muted"></i><p class="text-muted">Ảnh đã chụp hoặc tải lên sẽ hiện ở đây.</p>';
        });
        
        // Add or Update Item (merge if duplicate)
        function addOrUpdateItem(item, quantity) {
            const existingIndex = scannedData.findIndex(data => data.item.toLowerCase() === item.toLowerCase());
            
            if (existingIndex !== -1) {
                scannedData[existingIndex].quantity += quantity;
            } else {
                scannedData.push({ item, quantity });
            }
            
            updateTable();
        }
        
        // Update main table display
        function updateTable() {
            if (scannedData.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Chưa có dữ liệu.</td></tr>';
            } else {
                resultsTableBody.innerHTML = scannedData.map((data, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${data.item}</td>
                        <td>${data.quantity}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editItem(${index})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            }
            totalCount.textContent = scannedData.length;
        }
        
        // Edit item in the main list
        window.editItem = function(index) {
            const data = scannedData[index];
            const newItem = prompt('Sửa Item:', data.item);
            const newQuantity = prompt('Sửa Số lượng:', data.quantity);
            
            if (newItem !== null && newQuantity !== null) {
                scannedData[index].item = newItem;
                scannedData[index].quantity = parseInt(newQuantity) || data.quantity;
                updateTable();
            }
        };
        
        // Delete item from the main list
        window.deleteItem = function(index) {
            if (confirm('Bạn có chắc muốn xóa mục này?')) {
                scannedData.splice(index, 1);
                updateTable();
            }
        };
        
        // Clear all items
        clearAllBtn.addEventListener('click', () => {
            if (scannedData.length > 0 && confirm('Bạn có chắc muốn xóa tất cả dữ liệu?')) {
                scannedData = [];
                updateTable();
            }
        });
        
        // Export to Excel
        exportBtn.addEventListener('click', () => {
            if (scannedData.length === 0) {
                alert('Không có dữ liệu để xuất!');
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(scannedData.map((d, i) => ({'STT': i + 1, 'Item': d.item, 'Số Lượng': d.quantity})));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Danh Sách');
            XLSX.writeFile(workbook, `Ket_Qua_Quet_${new Date().toISOString().slice(0,10)}.xlsx`);
        });
        
        // Initialize
        updateTable();
    </script>
</body>
</html>
